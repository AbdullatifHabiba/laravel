name: Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Add PPA for newer PHP versions (Ubuntu 22.04 defaults to 8.1, Laravel needs 8.2+)
          if ! command -v php8.3 &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository ppa:ondrej/php -y
            sudo apt-get update
            sudo apt-get install -y php8.3 php8.3-cli php8.3-mbstring php8.3-xml php8.3-bcmath php8.3-mysql php8.3-curl php8.3-zip unzip
          fi

          # Create directory if not exists
          mkdir -p ~/laravel-app
          cd ~/laravel-app

          # Clone or Pull
          if [ -d ".git" ]; then
            # Reset to match remote to avoid conflicts
            git fetch origin main
            git reset --hard origin/main
          else
            # Clone if empty
            git clone https://github.com/laravel/laravel.git .
          fi

          # Install dependencies
          composer install --no-interaction --prefer-dist --optimize-autoloader

          # Copy .env example if not exists
          if [ ! -f .env ]; then
            cp .env.example .env
            php8.3 artisan key:generate
            # In a real scenario, we would replace DB credentials here using secrets
            # sed -i 's/DB_HOST=127.0.0.1/DB_HOST=${{ secrets.DB_HOST }}/g' .env
          fi

          # Run migrations
          php8.3 artisan migrate --force

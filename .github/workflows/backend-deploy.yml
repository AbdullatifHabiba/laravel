name: Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Ensure dependencies are installed
          if ! command -v php &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y php php-cli php-mbstring php-xml php-bcmath php-mysql composer unzip
          fi

          # Create directory if not exists
          mkdir -p ~/laravel-app
          cd ~/laravel-app

          # Clone or Pull
          if [ -d ".git" ]; then
            git pull origin main
          else
            # For demo purposes, we clone the laravel repo if empty, or assume it's already set up
            # In a real scenario, we might rsync the code from the runner or git clone
            git clone https://github.com/laravel/laravel.git . || true
            git pull origin main 
          fi

          # Install dependencies
          composer install --no-interaction --prefer-dist --optimize-autoloader

          # Copy .env example if not exists (should be managed by secrets in real life)
          if [ ! -f .env ]; then
            cp .env.example .env
            php artisan key:generate
            # Update DB credentials in .env here using sed or similar if needed
          fi

          # Run migrations
          php artisan migrate --force

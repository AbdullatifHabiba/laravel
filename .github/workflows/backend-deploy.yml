name: Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e  # Exit on any error
          
          echo "=== Starting deployment process ==="
          
          # Install PHP 8.3 and required extensions
          echo "=== Installing PHP 8.3 and dependencies ==="
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository ppa:ondrej/php -y
          sudo apt-get update
          sudo apt-get install -y \
            php8.3 \
            php8.3-cli \
            php8.3-fpm \
            php8.3-mbstring \
            php8.3-xml \
            php8.3-bcmath \
            php8.3-mysql \
            php8.3-curl \
            php8.3-zip \
            php8.3-gd \
            php8.3-intl \
            unzip \
            git \
            nginx

          # Install Composer
          echo "=== Installing Composer ==="
          if ! command -v composer &> /dev/null; then
            curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
          fi

          # Create directory if not exists
          mkdir -p ~/laravel-app
          cd ~/laravel-app

          # Clone or update repository
          echo "=== Setting up repository ==="
          if [ -d .git ]; then
            echo "Repository exists, pulling latest changes..."
            git fetch origin
            git reset --hard origin/12.x
            git clean -fd
          else
            echo "Cloning repository..."
            git clone https://github.com/AbdullatifHabiba/laravel.git .
          fi

          # Verify PHP version
          echo "=== Verifying PHP version ==="
          php8.3 --version

          # Set correct PHP version for CLI
          sudo update-alternatives --set php /usr/bin/php8.3

          # Install dependencies
          echo "=== Installing Composer dependencies ==="
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

          # Setup environment file
          echo "=== Setting up environment ==="
          if [ ! -f .env ]; then
            cp .env.example .env
            php8.3 artisan key:generate
          fi
          
          # Update database credentials
          sed -i "s/DB_HOST=.*/DB_HOST=${{ secrets.DB_HOST }}/g" .env
          sed -i "s/DB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}/g" .env
          sed -i "s/DB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/g" .env
          sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/g" .env

          # Set proper permissions
          echo "=== Setting permissions ==="
          sudo chown -R www-data:www-data ~/laravel-app/storage ~/laravel-app/bootstrap/cache
          sudo chmod -R 775 ~/laravel-app/storage ~/laravel-app/bootstrap/cache

          # Clear old cache
          echo "=== Clearing old cache ==="
          php8.3 artisan cache:clear
          php8.3 artisan config:clear
          php8.3 artisan route:clear
          php8.3 artisan view:clear

          # Run migrations
          echo "=== Running database migrations ==="
          php8.3 artisan migrate --force

          # Cache configuration
          echo "=== Caching configuration ==="
          php8.3 artisan config:cache
          php8.3 artisan route:cache
          php8.3 artisan view:cache

          # Restart PHP-FPM
          echo "=== Restarting PHP-FPM ==="
          sudo systemctl restart php8.3-fpm

          echo "=== Deployment completed successfully ==="